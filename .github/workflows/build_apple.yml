name: Build iOS XCFramework

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ iOS ] # 只在 iOS 分支触发
  pull_request:
    branches: [ iOS ] # 只在 iOS 分支触发

jobs:
  build-ios:
    runs-on: macos-latest # 必须用 macOS runner

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 安装 Rust（用 rust-toolchain.toml 自动管理版本）
      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          override: true

      # 3. 安装 cbindgen
      - name: 安装 cbindgen
        run: cargo install cbindgen

      # 3.5 安装 protobuf（protoc 编译器）
      - name: 安装 protobuf
        run: brew install protobuf

      # 4. 赋予脚本执行权限
      - name: 赋予 build_apple.sh 执行权限
        run: chmod +x scripts/build_apple.sh

      # 5. 执行打包脚本
      - name: 执行 iOS 打包脚本
        run: ./scripts/build_apple.sh

      # 6. 上传产物（可选，方便下载）
      - name: 上传 XCFramework 产物
        uses: actions/upload-artifact@v4
        with:
          name: clashrs.xcframework
          path: build/clashrs.xcframework 