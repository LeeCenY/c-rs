name: Build iOS XCFramework

on:
  push:
    branches: [ iOS ] # 每次 iOS 分支有提交就触发
  workflow_dispatch: # 保留手动触发选项

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 安装 Rust
      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          override: true

      # 3. 安装 cbindgen
      - name: 安装 cbindgen
        run: cargo install cbindgen

      # 4. 安装 protobuf
      - name: 安装 protobuf
        run: brew install protobuf

      # 5. 赋予 build_apple.sh 执行权限
      - name: 赋予 build_apple.sh 执行权限
        run: chmod +x scripts/build_apple.sh

      # 6. 执行打包脚本
      - name: 执行 iOS 打包脚本
        run: ./scripts/build_apple.sh

      # 7. 上传产物到 Actions（方便在页面直接下载）
      - name: 上传产物到 Actions
        uses: actions/upload-artifact@v4
        with:
          name: clashrs.xcframework
          path: build/clashrs.xcframework
          retention-days: 30 # 保留 30 天

      # 8. 打包 XCFramework 为 zip 文件
      - name: 打包 XCFramework 为 zip
        run: |
          cd build
          zip -r clashrs.xcframework.zip clashrs.xcframework
          echo "打包完成：clashrs.xcframework.zip"

      # 9. 创建/更新固定的 Release 并上传产物
      - name: 创建/更新 Release 并上传产物
        uses: softprops/action-gh-release@v2
        with:
          files: build/clashrs.xcframework.zip
          name: "iOS SDK Latest"
          tag_name: "ios-latest"
          body: |
            最新的 iOS SDK 包，自动从 iOS 分支构建。
            - 构建时间: ${{ github.event.head_commit.timestamp || github.event.repository.pushed_at }}
            - 提交信息: ${{ github.event.head_commit.message }}
            - 包含 clashrs.xcframework.zip
          # 始终覆盖同名 tag
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 